@using Microsoft.AspNetCore.Identity
@using SysJaky_N.Models
@using SysJaky_N.Models.ViewModels
@using SysJaky_N.Pages.Account
@inject SignInManager<ApplicationUser> SignInManager
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    var accountLabel = User?.Identity?.Name;
    if (string.IsNullOrWhiteSpace(accountLabel))
    {
        accountLabel = Localizer["AccountMenuLabel"].Value;
    }

    var pathValue = Context.Request.Path.HasValue ? Context.Request.Path.Value : "/";
    if (string.IsNullOrWhiteSpace(pathValue))
    {
        pathValue = "/";
    }

    var queryValue = Context.Request.QueryString.HasValue ? Context.Request.QueryString.Value : string.Empty;
    var returnUrl = string.Concat(pathValue, queryValue);
}

@if (SignInManager.IsSignedIn(User))
{
    <div class="dropdown">
        <button class="btn btn-outline-light btn-sm dropdown-toggle d-flex align-items-center gap-2"
                id="userMenuDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
                aria-label="@Localizer["AccountMenuAriaLabel"]">
            <i class="bi bi-person-circle" aria-hidden="true"></i>
            <span class="text-truncate" style="max-width: 12rem;">@accountLabel</span>
        </button>
        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuDropdown">
            <li>
                <a class="dropdown-item d-flex align-items-center gap-2" asp-page="/Account/Manage">
                    <i class="bi bi-gear" aria-hidden="true"></i>
                    <span>@Localizer["ManageAccount"]</span>
                </a>
            </li>
            <li><hr class="dropdown-divider" /></li>
            <li>
                <form method="post" asp-page="/Account/Logout" asp-route-returnUrl="@returnUrl" class="px-3">
                    <button type="submit" class="dropdown-item d-flex align-items-center gap-2 btn btn-link px-0 text-start">
                        <i class="bi bi-box-arrow-right" aria-hidden="true"></i>
                        <span>@Localizer["Logout"]</span>
                    </button>
                </form>
            </li>
        </ul>
    </div>
}
else
{
    var loginFormOptions = new LoginFormOptions
    {
        FormId = "navbar-login-form",
        FormCssClass = "login-dropdown-form",
        HeadingLocalizationKey = null,
        HeadingTagName = null,
        HeadingId = null,
        ValidationSummaryCssClass = "text-danger small mb-3",
        AspPage = "/Account/Login",
        IncludeAntiforgery = true,
        EmailInputId = "navbar-login-email",
        PasswordInputId = "navbar-login-password",
        RememberMeInputId = "navbar-login-remember",
        AltchaId = "navbar-login-altcha",
        AltchaChallengeUrl = "~/altcha/challenge",
        AltchaWorkerVersionSuffix = string.Empty,
        AltchaWorkers = "1",
        AltchaMaxNumber = "500000",
        EnableRefetchOnExpire = true,
        ShowRememberMe = true,
        Input = new LoginModel.InputModel()
    };

    <div class="d-flex align-items-center gap-2">
        <div class="dropdown login-dropdown">
            <button class="btn btn-outline-light btn-sm d-flex align-items-center gap-2 login-dropdown-toggle"
                    id="navbarLoginDropdown"
                    type="button"
                    data-bs-toggle="dropdown"
                    data-bs-auto-close="outside"
                    aria-expanded="false"
                    aria-haspopup="true"
                    aria-controls="navbar-login-menu">
                <i class="bi bi-box-arrow-in-right" aria-hidden="true"></i>
                <span>@Localizer["Login"]</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end login-dropdown-menu" aria-labelledby="navbarLoginDropdown navbar-login-heading" id="navbar-login-menu">
                <div class="login-dropdown-card">
                    <div class="login-dropdown-header">
                        <div class="login-dropdown-icon" aria-hidden="true">
                            <i class="bi bi-shield-lock"></i>
                        </div>
                        <div class="login-dropdown-heading">
                            <span class="login-dropdown-eyebrow text-uppercase fw-semibold">@Localizer["AccountMenuLabel"]</span>
                            <h2 id="navbar-login-heading" class="login-dropdown-title mb-1">@Localizer["Login"]</h2>
                            <p class="login-dropdown-subtitle mb-0">@Localizer["LoginSubtitle"]</p>
                        </div>
                    </div>
                    <div class="login-dropdown-body">
                        <partial name="~/Pages/Shared/Account/_LoginForm.cshtml" model="loginFormOptions" />
                    </div>
                    <div class="login-dropdown-footer">
                        <span class="login-dropdown-footer-text">@Localizer["NoAccountQuestion"]</span>
                        <a class="login-dropdown-footer-link" asp-page="/Account/Register" asp-route-returnUrl="@returnUrl">
                            <span>@Localizer["Register"]</span>
                            <i class="bi bi-arrow-right-short" aria-hidden="true"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <a class="btn btn-light btn-sm d-flex align-items-center gap-2 login-register-button" asp-page="/Account/Register" asp-route-returnUrl="@returnUrl">
            <i class="bi bi-person-plus" aria-hidden="true"></i>
            <span>@Localizer["Register"]</span>
        </a>
    </div>
}
