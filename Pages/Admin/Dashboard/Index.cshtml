@page
@model SysJaky_N.Pages.Admin.Dashboard.IndexModel
@inject IStringLocalizer<SysJaky_N.Pages.Admin.Dashboard.IndexModel> Localizer
@{
    ViewData["Title"] = Localizer["PageTitle"];
}

<h1 class="mb-4">@Localizer["PageTitle"]</h1>

@if (TempData["ChatbotSettingsSavedMessage"] is string savedMessage)
{
    <div class="alert alert-success" role="alert">
        @savedMessage
    </div>
}

<div class="row g-4">
    <div class="col-12 col-xxl-9">
        <div class="card shadow-sm mb-4">
            <div class="card-header py-3">
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3">
                    <div>
                        <h2 class="h5 mb-1">@Localizer["OverviewFilterTitle"]</h2>
                        <p class="text-muted mb-0">@Localizer["OverviewFilterDescription"]</p>
                    </div>
                    <div class="d-flex flex-wrap gap-2">
                        <button id="preset7" type="button" class="btn btn-outline-secondary btn-sm" data-range="7">
                            @Localizer["PresetLast7Days"]
                        </button>
                        <button id="preset30" type="button" class="btn btn-outline-secondary btn-sm" data-range="30">
                            @Localizer["PresetLast30Days"]
                        </button>
                        <button id="preset365" type="button" class="btn btn-outline-secondary btn-sm" data-range="365">
                            @Localizer["PresetLast12Months"]
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="dashboardFilters" class="row g-3 align-items-end" autocomplete="off">
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterFrom">@Localizer["FilterFromLabel"]</label>
                        <input id="filterFrom" type="date" class="form-control" required />
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterTo">@Localizer["FilterToLabel"]</label>
                        <input id="filterTo" type="date" class="form-control" required />
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterNorms">@Localizer["FilterNormsLabel"]</label>
                        <select id="filterNorms" class="form-select" multiple size="4" aria-describedby="filterNormsHelp"></select>
                        <div id="filterNormsHelp" class="form-text">@Localizer["FilterNormsHelp"]</div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterCities">@Localizer["FilterCitiesLabel"]</label>
                        <select id="filterCities" class="form-select" multiple size="4" aria-describedby="filterCitiesHelp"></select>
                        <div id="filterCitiesHelp" class="form-text">@Localizer["FilterCitiesHelp"]</div>
                    </div>
                    <div class="col-12 d-flex flex-wrap gap-2">
                        <button id="applyFilters" type="submit" class="btn btn-primary">
                            <i class="bi bi-arrow-repeat"></i> @Localizer["ApplyFiltersButton"]
                        </button>
                        <button id="exportReport" type="button" class="btn btn-outline-success">
                            <i class="bi bi-file-earmark-excel"></i> @Localizer["ExportReportButton"]
                        </button>
                        <div id="filtersStatus" class="text-muted small align-self-center">
                            <span class="spinner-border spinner-border-sm me-2 d-none" id="filtersSpinner" role="status" aria-hidden="true"></span>
                            <span id="filtersStatusText">@Localizer["FiltersStatusReady"]</span>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <div class="row g-3 mb-4" id="summaryCards">
            <div class="col-sm-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted text-uppercase fw-semibold mb-1">@Localizer["SummaryRevenue"]</p>
                        <p class="display-6 mb-0" id="summaryRevenue">—</p>
                        <p class="text-success small mb-0" id="summaryRevenueChange"></p>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted text-uppercase fw-semibold mb-1">@Localizer["SummaryOrders"]</p>
                        <p class="display-6 mb-0" id="summaryOrders">—</p>
                        <p class="text-muted small mb-0" id="summaryAverageOrder">—</p>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted text-uppercase fw-semibold mb-1">@Localizer["SummarySeats"]</p>
                        <p class="display-6 mb-0" id="summarySeats">—</p>
                        <p class="text-muted small mb-0" id="summaryOccupancy">—</p>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-muted text-uppercase fw-semibold mb-1">@Localizer["SummaryCustomers"]</p>
                        <p class="display-6 mb-0" id="summaryCustomers">—</p>
                        <p class="text-muted small mb-0" id="summaryNewCustomers">—</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
                <div>
                    <h2 class="h5 mb-0">@Localizer["SalesTrendTitle"]</h2>
                    <small class="text-muted" id="salesRangeLabel">—</small>
                </div>
                <div class="text-muted small" id="salesAggregateLabel"></div>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart" height="280" role="img" aria-label="@Localizer["SalesTrendChartLabel"]"></canvas>
                <p class="text-muted small mt-3 mb-0" id="salesEmpty" hidden>
                    @Localizer["SalesTrendEmpty"]
                </p>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
                <h2 class="h5 mb-0">@Localizer["TopCoursesTitle"]</h2>
                <small class="text-muted" id="topCoursesTotal">—</small>
            </div>
            <div class="card-body">
                <canvas id="topCoursesChart" height="240" role="img" aria-label="@Localizer["TopCoursesChartLabel"]"></canvas>
                <div class="table-responsive mt-4">
                    <table class="table table-sm mb-0 align-middle">
                        <thead>
                            <tr>
                                <th scope="col">@Localizer["TopCoursesColumnCourse"]</th>
                                <th scope="col" class="text-end">@Localizer["TopCoursesColumnRevenue"]</th>
                                <th scope="col" class="text-end">@Localizer["TopCoursesColumnSeats"]</th>
                            </tr>
                        </thead>
                        <tbody id="topCoursesTable">
                            <tr><td colspan="3" class="text-center text-muted py-3">@Localizer["Loading"]</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-2">
                        <h2 class="h5 mb-0">@Localizer["ConversionFunnelTitle"]</h2>
                        <small class="text-muted" id="conversionRates">—</small>
                    </div>
                    <div class="card-body">
                        <canvas id="conversionChart" height="240" role="img" aria-label="@Localizer["ConversionChartLabel"]"></canvas>
                        <ul class="list-unstyled mt-3 mb-0" id="conversionDetails">
                            <li class="text-muted">@Localizer["Loading"]</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        <h2 class="h5 mb-0">@Localizer["TermPopularityTitle"]</h2>
                    </div>
                    <div class="card-body">
                        <canvas id="heatmapChart" height="260" role="img" aria-label="@Localizer["TermPopularityChartLabel"]"></canvas>
                        <p class="text-muted small mt-3 mb-0" id="heatmapEmpty" hidden>
                            @Localizer["TermPopularityEmpty"]
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xxl-3">
        <div class="card shadow-sm mb-4">
            <div class="card-header">
                <h2 class="h5 mb-0">@Localizer["RealtimeStatsTitle"]</h2>
            </div>
            <div class="card-body">
                <p class="mb-2">
                    <span class="text-muted d-block">@Localizer["RealtimeUsersLabel"]</span>
                    <span class="fs-3 fw-semibold" id="realtimeUsers">—</span>
                </p>
                <p class="mb-2">
                    <span class="text-muted d-block">@Localizer["RealtimeCartsLabel"]</span>
                    <span class="fs-3 fw-semibold" id="realtimeCarts">—</span>
                </p>
                <p class="mb-0">
                    <span class="text-muted d-block">@Localizer["RealtimeCartValueLabel"]</span>
                    <span class="fs-5" id="realtimeCartValue">—</span>
                </p>
                <p class="text-muted small mt-3 mb-0" id="realtimeUpdated">Čekám na připojení…</p>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h5 mb-0">Nastavení chatbota</h2>
                    <small class="text-muted">Spravujte zobrazení virtuálního poradce.</small>
                </div>
                @if (TempData["ChatbotSettingsSaved"] is bool badgeSaved && badgeSaved)
                {
                    <span class="badge bg-success">Uloženo</span>
                }
            </div>
            <div class="card-body">
                <form method="post" asp-page-handler="Chatbot" class="vstack gap-3">
                    @Html.AntiForgeryToken()
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" asp-for="ChatbotSettings.IsEnabled" id="chatbotEnabled" />
                        <label class="form-check-label" for="chatbotEnabled">Zobrazit chatbota na webu</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" asp-for="ChatbotSettings.AutoInitialize" id="chatbotAuto" />
                        <label class="form-check-label" for="chatbotAuto">Automaticky inicializovat po načtení stránky</label>
                    </div>
                    <button type="submit" class="btn btn-primary align-self-start">
                        <i class="bi bi-save"></i> Uložit nastavení
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/chart.js/chart.js" asp-append-version="true"></script>
    <script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.5/dist/browser/signalr.min.js" crossorigin="anonymous"></script>
    <script src="~/js/admin/dashboard.js" asp-append-version="true"></script>
    <script>
        window.dashboardKonfigurace = {
            api: {
                filtry: '@Url.Content("~/api/analytics/filters")',
                prehled: '@Url.Content("~/api/analytics/dashboard")',
                export: '@Url.Content("~/api/analytics/export")',
                hub: '@Url.Content("~/hubs/dashboard")'
            },
            texty: {
                zadnaData: 'Žádná data',
                mena: '@System.Globalization.CultureInfo.CurrentCulture.NumberFormat.CurrencySymbol'
            }
        };
    </script>
}
