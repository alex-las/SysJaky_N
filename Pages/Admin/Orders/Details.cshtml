@page "{id:int}"
@model SysJaky_N.Pages.Admin.Orders.DetailsModel
@{
    ViewData["Title"] = $"Order {Model.Order.Id}";
}

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a asp-page="Index">Orders</a></li>
        <li class="breadcrumb-item active" aria-current="page">Order @Model.Order.Id</li>
    </ol>
</nav>

<h1>Order @Model.Order.Id</h1>
<p>Status: @Model.Order.Status</p>
<p>Date: @Model.Order.CreatedAt</p>

<table class="table">
    <thead>
        <tr>
            <th>Course</th>
            <th>Quantity</th>
            <th>Unit price (excl. VAT)</th>
            <th>VAT</th>
            <th>Total</th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model.Order.Items)
    {
        <tr>
            <td>@item.Course?.Title</td>
            <td>@item.Quantity</td>
            <td>@item.UnitPriceExclVat</td>
            <td>@item.Vat</td>
            <td>@item.Total</td>
        </tr>
    }
    </tbody>
</table>
<p>Subtotal (excl. VAT): @Model.Order.PriceExclVat</p>
<p>VAT: @Model.Order.Vat</p>
<p>Total: @Model.Order.Total</p>

@{
    var hasSeatTokens = Model.Order.Items.Any(i => i.SeatTokens.Count > 0);
}

@if (Model.Order.Status == OrderStatus.Paid && hasSeatTokens)
{
    <h2>Seat tokens</h2>
    @foreach (var item in Model.Order.Items)
    {
        if (item.SeatTokens.Count == 0)
        {
            continue;
        }

        <h3>@(item.Course?.Title ?? $"Course {item.CourseId}")</h3>
        <ul>
            @foreach (var token in item.SeatTokens)
            {
                <li>
                    <code>@token.Token</code>
                    @if (token.RedeemedAtUtc.HasValue)
                    {
                        <span>- redeemed @token.RedeemedAtUtc.Value.ToLocalTime().ToString("g")</span>
                    }
                    else
                    {
                        <span>- available</span>
                    }
                </li>
            }
        </ul>
    }
}

@if (!string.IsNullOrEmpty(Model.QrCodeImage))
{
    <img src="@Model.QrCodeImage" alt="QR code" />
}

@if (Model.PaymentEnabled && Model.Order.Status == OrderStatus.Pending)
{
    <form method="post" asp-page-handler="Pay">
        <button type="submit" class="btn btn-primary">Start Payment</button>
    </form>
}

@if (Model.Order.Status == OrderStatus.Paid)
{
    <a class="btn btn-secondary" asp-page-handler="DownloadInvoice" asp-route-id="@Model.Order.Id">Download Invoice</a>
}
