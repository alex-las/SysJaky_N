@page "{id:int}"
@model SysJaky_N.Pages.Courses.DetailsModel
@{
    var metaTitle = string.IsNullOrWhiteSpace(Model.Course.MetaTitle)
        ? Model.Course.Title
        : Model.Course.MetaTitle.Trim();
    var metaDescriptionRaw = !string.IsNullOrWhiteSpace(Model.Course.MetaDescription)
        ? Model.Course.MetaDescription
        : Model.Course.Description;
    var metaDescription = metaDescriptionRaw?.ReplaceLineEndings(" ").Trim();
    var hasMetaDescription = !string.IsNullOrWhiteSpace(metaDescription);
    var ogImage = Model.Course.OpenGraphImage;
    var resolvedTitle = string.IsNullOrWhiteSpace(metaTitle) ? Model.Course.Title : metaTitle;
    ViewData["Title"] = resolvedTitle;
}

@section Head {
    <meta property="og:title" content="@resolvedTitle" />
    <meta property="og:type" content="website" />
    @if (hasMetaDescription)
    {
        <meta name="description" content="@metaDescription" />
        <meta property="og:description" content="@metaDescription" />
    }
    @if (!string.IsNullOrWhiteSpace(ogImage))
    {
        <meta property="og:image" content="@ogImage" />
    }
    @{
        var jsonLdDescription = (Model.Course.Description ?? string.Empty)
            .ReplaceLineEndings(" ")
            .Replace("\"", "'");
        var jsonLdData = new
        {
            @context = "https://schema.org",
            @type = "Course",
            name = Model.Course.Title,
            description = jsonLdDescription,
            provider = new
            {
                @type = "Organization",
                name = "Systémy jakosti",
                sameAs = "https://www.systemy-jakosti.cz/"
            },
            hasCourseInstance = new
            {
                @type = "CourseInstance",
                startDate = Model.Course.Date.ToString("yyyy-MM-dd"),
                courseMode = Model.Course.Mode ?? string.Empty,
                offers = new
                {
                    @type = "Offer",
                    price = Model.Course.Price,
                    priceCurrency = "CZK",
                    availability = "https://schema.org/InStock"
                }
            }
        };
        var jsonLd = System.Text.Json.JsonSerializer.Serialize(
            jsonLdData,
            new System.Text.Json.JsonSerializerOptions
            {
                Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            });
    }
    <script type="application/ld+json">
        @Html.Raw(jsonLd)
    </script>
}

<h1>@Model.Course.Title</h1>

@if (!string.IsNullOrEmpty(Model.Course.CoverImageUrl))
{
    <figure class="mb-4">
        <img src="@Model.Course.CoverImageUrl" alt="Obálka kurzu @Model.Course.Title" class="img-fluid rounded" />
    </figure>
}

@if (TempData["CartError"] is string cartError && !string.IsNullOrWhiteSpace(cartError))
{
    <div class="alert alert-danger" role="alert">@cartError</div>
}

<p>@Model.Course.Description</p>
<p>Price: @Model.Course.Price.ToString("C")</p>
<p>Date: @Model.Course.Date.ToShortDateString()</p>
<p><a href="/Courses/ICS/@Model.Course.Id">Přidat do kalendáře</a></p>

@if (Model.CourseBlock != null)
{
    <h2>Part of block: @Model.CourseBlock.Title</h2>
    <p>@Model.CourseBlock.Description</p>
    <p>Block price: @Model.CourseBlock.Price</p>
    <form method="post" asp-page-handler="OrderBlock">
        <input type="hidden" name="blockId" value="@Model.CourseBlock.Id" />
        <button type="submit" class="btn btn-secondary">Order entire block</button>
    </form>
}

<form method="post">
    <button type="submit" class="btn btn-primary" aria-label="Add @Model.Course.Title to cart">Add to cart</button>
</form>

@if (User.Identity?.IsAuthenticated ?? false)
{
    <form method="post" asp-page-handler="AddToWishlist">
        <button type="submit" class="btn btn-outline-secondary">Přidat do wishlistu</button>
    </form>
}

<section class="mt-4">
    <h2>Lekce</h2>
    @if (Model.Lessons.Any())
    {
        <div class="list-group">
            @foreach (var lesson in Model.Lessons)
            {
                Model.ProgressByLessonId.TryGetValue(lesson.Id, out var progressInfo);
                var completion = progressInfo?.Progress ?? 0;
                <div class="list-group-item">
                    <div class="d-flex flex-column gap-2">
                        <div class="d-flex justify-content-between flex-wrap gap-3">
                            <div>
                                <div class="fw-semibold">Lekce pořadí: @lesson.Order</div>
                                <div class="text-muted">Typ: @lesson.Type</div>
                                @if (!string.IsNullOrWhiteSpace(lesson.ContentUrl))
                                {
                                    <a class="link-primary" href="@lesson.ContentUrl" target="_blank" rel="noopener">Otevřít obsah</a>
                                }
                            </div>
                            <div class="text-end">
                                <div class="fw-semibold">@completion&nbsp;% dokončeno</div>
                                @if (progressInfo is not null)
                                {
                                    <div class="text-muted small">Naposledy @(progressInfo.LastSeenUtc.ToLocalTime().ToString("g"))</div>
                                }
                            </div>
                        </div>
                        @if (User.Identity?.IsAuthenticated ?? false)
                        {
                            <form method="post" asp-page-handler="UpdateProgress" asp-route-id="@Model.Course.Id" class="d-flex flex-column flex-sm-row align-items-sm-center gap-2">
                                <input type="hidden" name="lessonId" value="@lesson.Id" />
                                <div class="input-group input-group-sm" style="max-width: 220px;">
                                    <span class="input-group-text">Progres</span>
                                    <input type="number" class="form-control" name="progress" min="0" max="100" value="@completion" aria-label="Procento dokončení lekce pořadí @lesson.Order" />
                                    <span class="input-group-text">%</span>
                                </div>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="submit" class="btn btn-sm btn-primary">Uložit</button>
                                    <button type="submit" class="btn btn-sm btn-outline-success" onclick="this.form.querySelector('[name=progress]').value = 100;">Dokončeno</button>
                                </div>
                            </form>
                        }
                        else
                        {
                            <p class="text-muted small mb-0">Přihlaste se pro sledování postupu.</p>
                        }
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-muted">Pro tento kurz zatím nejsou dostupné lekce.</p>
    }
</section>

@if (Model.Reviews.Any())
{
    <h2>Reviews</h2>
    <ul>
        @foreach (var review in Model.Reviews)
        {
            <li>
                <strong>@review.Rating/5</strong> @review.User?.UserName on @review.CreatedAt.ToShortDateString()
                <div>@review.Comment</div>
            </li>
        }
    </ul>
}

@if (User.Identity?.IsAuthenticated ?? false)
{
    <h3>Add Review</h3>
    <form method="post" asp-page-handler="Review">
        <div class="mb-3">
            <label asp-for="NewReview.Rating" class="form-label"></label>
            <input asp-for="NewReview.Rating" class="form-control" min="1" max="5" />
            <span asp-validation-for="NewReview.Rating" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="NewReview.Comment" class="form-label"></label>
            <textarea asp-for="NewReview.Comment" class="form-control"></textarea>
            <span asp-validation-for="NewReview.Comment" class="text-danger"></span>
        </div>
        <button type="submit" class="btn btn-success">Submit</button>
    </form>
}
else
{
    <p><a asp-page="/Account/Login">Log in</a> to add a review.</p>
}

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

