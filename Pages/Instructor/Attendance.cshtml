@page
@model SysJaky_N.Pages.Instructor.AttendanceModel
@using System.Text.Json
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["Title"];
}

<h1 class="mb-4">@Localizer["Heading"]</h1>
<p class="text-muted">@Localizer["Intro"]</p>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                @Localizer["ScanQr"]
            </div>
            <div class="card-body">
                <div id="qr-reader" class="border rounded position-relative" style="min-height: 320px;">
                    <div id="qr-reader-placeholder" class="position-absolute top-50 start-50 translate-middle text-muted">@Localizer["PlaceholderCameraInitialising"]</div>
                </div>
                <div id="qr-reader-error" class="alert alert-warning mt-3 d-none" role="alert"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header">
                @Localizer["ManualEntry"]
            </div>
            <div class="card-body">
                <form id="manual-form" class="mb-3" autocomplete="off">
                    <label for="manualCode" class="form-label">@Localizer["ManualCodeLabel"]</label>
                    <input type="text" id="manualCode" class="form-control" autocomplete="off" />
                    <div class="form-text">@Html.Raw(Localizer["ManualHelper", "<code>enrollment=123</code>"].Value)</div>
                    <button type="submit" class="btn btn-primary mt-3">@Localizer["ManualSubmit"]</button>
                </form>
                <div id="result" class="alert d-none" role="alert"></div>
                <div id="details" class="card d-none">
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">@Localizer["DetailEnrollmentId"]</dt>
                            <dd class="col-sm-8" id="detail-enrollment-id"></dd>
                            <dt class="col-sm-4">@Localizer["DetailParticipant"]</dt>
                            <dd class="col-sm-8" id="detail-participant"></dd>
                            <dt class="col-sm-4">@Localizer["DetailCourse"]</dt>
                            <dd class="col-sm-8" id="detail-course"></dd>
                            <dt class="col-sm-4">@Localizer["DetailTermStart"]</dt>
                            <dd class="col-sm-8" id="detail-term-start"></dd>
                            <dt class="col-sm-4">@Localizer["DetailTermEnd"]</dt>
                            <dd class="col-sm-8" id="detail-term-end"></dd>
                            <dt class="col-sm-4">@Localizer["DetailCheckedIn"]</dt>
                            <dd class="col-sm-8" id="detail-checked-in"></dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://unpkg.com/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>
    <script>
        (() => {
            const resultBox = document.getElementById('result');
            const detailsCard = document.getElementById('details');
            const enrollmentIdEl = document.getElementById('detail-enrollment-id');
            const participantEl = document.getElementById('detail-participant');
            const courseEl = document.getElementById('detail-course');
            const termStartEl = document.getElementById('detail-term-start');
            const termEndEl = document.getElementById('detail-term-end');
            const checkedInEl = document.getElementById('detail-checked-in');
            const manualForm = document.getElementById('manual-form');
            const manualInput = document.getElementById('manualCode');
            const qrError = document.getElementById('qr-reader-error');
            const placeholder = document.getElementById('qr-reader-placeholder');

            const resetDetails = () => {
                detailsCard.classList.add('d-none');
                enrollmentIdEl.textContent = '';
                participantEl.textContent = '';
                courseEl.textContent = '';
                termStartEl.textContent = '';
                termEndEl.textContent = '';
                checkedInEl.textContent = '';
            };

            const resources = {
                messageCheckedIn: @Html.Raw(JsonSerializer.Serialize(Localizer["MessageCheckedIn"].Value)),
                messageAlreadyCheckedIn: @Html.Raw(JsonSerializer.Serialize(Localizer["MessageAlreadyCheckedIn"].Value)),
                messageAttendanceFailed: @Html.Raw(JsonSerializer.Serialize(Localizer["MessageAttendanceFailed"].Value)),
                messageMissingCode: @Html.Raw(JsonSerializer.Serialize(Localizer["MessageMissingCode"].Value)),
                messageUnexpected: @Html.Raw(JsonSerializer.Serialize(Localizer["MessageUnexpected"].Value)),
                logParseError: @Html.Raw(JsonSerializer.Serialize(Localizer["LogParseError"].Value)),
                errorCameraAccess: @Html.Raw(JsonSerializer.Serialize(Localizer["ErrorCameraAccess"].Value)),
                errorCameraInit: @Html.Raw(JsonSerializer.Serialize(Localizer["ErrorCameraInit"].Value)),
                errorQrUnavailable: @Html.Raw(JsonSerializer.Serialize(Localizer["ErrorQrUnavailable"].Value)),
                errorQrUnsupported: @Html.Raw(JsonSerializer.Serialize(Localizer["ErrorQrUnsupported"].Value))
            };

            const showResult = (type, message, details) => {
                resultBox.className = '';
                resultBox.classList.add('alert', type);
                resultBox.textContent = message;
                resultBox.classList.remove('d-none');

                if (details) {
                    detailsCard.classList.remove('d-none');
                    enrollmentIdEl.textContent = details.enrollmentId ?? '';
                    participantEl.textContent = details.participant ?? '';
                    courseEl.textContent = details.course ?? '';
                    termStartEl.textContent = details.termStart ?? '';
                    termEndEl.textContent = details.termEnd ?? '';
                    checkedInEl.textContent = details.checkedIn ?? '';
                } else {
                    resetDetails();
                }
            };

            const formatDateTime = value => {
                if (!value) {
                    return 'â€”';
                }

                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }

                return date.toLocaleString();
            };

            const processResponse = payload => {
                const { status, checkedInAtUtc, enrollment } = payload ?? {};
                const messages = {
                    'checked-in': resources.messageCheckedIn,
                    'already-checked-in': resources.messageAlreadyCheckedIn
                };
                const message = messages[status] ?? resources.messageCheckedIn;

                showResult('alert-success', message, {
                    enrollmentId: enrollment?.id,
                    participant: enrollment?.participant,
                    course: enrollment?.course,
                    termStart: formatDateTime(enrollment?.courseTermStartUtc),
                    termEnd: formatDateTime(enrollment?.courseTermEndUtc),
                    checkedIn: formatDateTime(checkedInAtUtc)
                });
            };

            const handleErrorResponse = async response => {
                let message = resources.messageAttendanceFailed;
                try {
                    const data = await response.json();
                    if (data?.message) {
                        message = data.message;
                    }
                } catch (err) {
                    console.warn(resources.logParseError, err);
                }

                showResult('alert-danger', message);
            };

            const submitCode = async code => {
                if (!code) {
                    showResult('alert-warning', resources.messageMissingCode);
                    return;
                }

                try {
                    const response = await fetch('/api/attendance/check-in', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ code })
                    });

                    if (response.ok) {
                        const payload = await response.json();
                        processResponse(payload);
                    } else {
                        await handleErrorResponse(response);
                    }
                } catch (err) {
                    console.error(@Html.Raw(JsonSerializer.Serialize(Model.CheckInRequestFailedLogMessage)), err);
                    showResult('alert-danger', resources.messageUnexpected);
                }
            };

            manualForm.addEventListener('submit', event => {
                event.preventDefault();
                submitCode(manualInput.value.trim());
            });

            if (window.Html5Qrcode) {
                const html5QrCode = new Html5Qrcode('qr-reader');
                let lastScanned = '';

                const onScanSuccess = decodedText => {
                    if (!decodedText) {
                        return;
                    }

                    if (decodedText === lastScanned) {
                        return;
                    }

                    lastScanned = decodedText;
                    manualInput.value = decodedText;
                    submitCode(decodedText);

                    setTimeout(() => {
                        lastScanned = '';
                    }, 3000);
                };

                html5QrCode
                    .start({ facingMode: 'environment' }, { fps: 10, qrbox: 250 }, onScanSuccess, () => { })
                    .then(() => {
                        if (placeholder) {
                            placeholder.classList.add('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Unable to start QR scanner.', error);
                        if (placeholder) {
                            placeholder.textContent = resources.errorCameraAccess;
                        }
                        if (qrError) {
                            qrError.textContent = (error && error.message) ? error.message : resources.errorCameraInit;
                            qrError.classList.remove('d-none');
                        }
                    });
            } else {
                if (placeholder) {
                    placeholder.textContent = resources.errorQrUnavailable;
                }
                if (qrError) {
                    qrError.textContent = resources.errorQrUnsupported;
                    qrError.classList.remove('d-none');
                }
            }
        })();
    </script>
}
